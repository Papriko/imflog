<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>IMF // MISSION LOG</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="IMF LOG">
    <meta name="theme-color" content="#020617">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">

    <style>
        [x-cloak] { display: none !important; }
        :root {
            --bg-deep: #020617;
            --bg-radial: radial-gradient(circle at 50% 0%, #0f172a 0%, #020617 80%);
            --bg-grid: rgba(56, 189, 248, 0.05);
            --glass-panel: rgba(15, 23, 42, 0.85);
            --glass-border: rgba(56, 189, 248, 0.3);
            --text-pri: #e0f2fe;
            --text-sec: #94a3b8;
            --text-accent: #38bdf8;
            --alert-red: #ef4444;
            --alert-glow: 0 0 10px rgba(239, 68, 68, 0.6);
            --tech-line: #1e293b;
            --input-bg: rgba(0, 0, 0, 0.3);
        }
        body[data-theme="light"] {
            --bg-deep: #f8fafc;
            --bg-radial: radial-gradient(circle at 50% 0%, #ffffff 0%, #f1f5f9 80%);
            --bg-grid: rgba(15, 23, 42, 0.03);
            --glass-panel: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(148, 163, 184, 0.4);
            --text-pri: #0f172a;
            --text-sec: #64748b;
            --text-accent: #0284c7;
            --alert-red: #dc2626;
            --alert-glow: none;
            --tech-line: #e2e8f0;
            --input-bg: rgba(255, 255, 255, 0.5);
        }
        body {
            background-color: var(--bg-deep);
            background-image: var(--bg-radial);
            color: var(--text-pri);
            /* Â¢ûÂä†‰∫Ü‰∏≠ÊñáÂ≠ó‰ΩìÂõûÈÄÄÔºå‰øùËØÅ‰∏≠ÊñáÊòæÁ§∫Á°¨Êúó */
            font-family: 'Rajdhani', 'Microsoft YaHei', 'PingFang SC', sans-serif;
            min-height: 100vh;
            overscroll-behavior: none;
            transition: all 0.3s ease;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .perspective-grid {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(var(--bg-grid) 1px, transparent 1px), linear-gradient(90deg, var(--bg-grid) 1px, transparent 1px);
            background-size: 50px 50px; pointer-events: none; z-index: -1; mask-image: linear-gradient(to bottom, black 40%, transparent 100%);
        }
        .hud-card {
            background: var(--glass-panel); backdrop-filter: blur(12px); border: 1px solid transparent; position: relative;
            box-shadow: -1px -1px 0 var(--glass-border), 1px 1px 0 var(--glass-border);
        }
        .hud-dropdown {
            background: var(--bg-deep); border: 1px solid var(--glass-border);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 50;
        }
        .hud-card::before { content: ''; position: absolute; top: -1px; right: -1px; width: 10px; height: 10px; border-top: 2px solid var(--text-accent); border-right: 2px solid var(--text-accent); }
        .hud-card::after { content: ''; position: absolute; bottom: -1px; left: -1px; width: 10px; height: 10px; border-bottom: 2px solid var(--text-accent); border-left: 2px solid var(--text-accent); }
        .btn-tac { background: transparent; border: 1px solid var(--glass-border); color: var(--text-sec); text-transform: uppercase; letter-spacing: 0.1em; font-weight: 700; transition: all 0.2s; position: relative; overflow: hidden; }
        .btn-tac:hover { border-color: var(--text-accent); color: var(--text-accent); box-shadow: 0 0 8px var(--glass-border); }
        .btn-red { background: rgba(239, 68, 68, 0.1); border: 1px solid var(--alert-red); color: var(--alert-red); }
        .btn-red:hover { background: var(--alert-red); color: white; box-shadow: var(--alert-glow); }
        .bar-bg { background: var(--tech-line); height: 6px; width: 100%; position: relative; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--alert-red); box-shadow: var(--alert-glow); transition: width 0.5s ease; }
        input, textarea, select { background: var(--input-bg); border: 1px solid var(--glass-border); color: var(--text-pri); font-family: 'Rajdhani', sans-serif; }
        input:focus, textarea:focus { outline: none; border-color: var(--text-accent); }
        .deco-text { font-size: 9px; letter-spacing: 2px; color: var(--text-sec); opacity: 0.5; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--text-sec); border-radius: 3px; }
    </style>
</head>

<body x-data="spyTracker()" x-init="init()" :data-theme="theme" class="pb-20 pt-safe">

    <div class="perspective-grid"></div>

    <div class="max-w-6xl mx-auto p-4 md:p-8 relative z-10" x-cloak>

        <!-- HEADER -->
        <header class="flex flex-col md:flex-row justify-between items-end border-b border-[var(--glass-border)] pb-6 mb-10 gap-6">
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <span class="w-2 h-2 bg-[var(--alert-red)] animate-pulse"></span>
                    <span class="deco-text" x-text="cloud.active ? txt.online : txt.offline"></span>
                </div>
                <h1 class="text-5xl font-bold tracking-tight text-[var(--text-pri)]" style="text-shadow: 0 0 20px var(--glass-border)">
                    MISSION <span class="text-[var(--text-accent)]">LOG</span>
                </h1>
                <div class="mt-2 text-sm text-[var(--text-sec)] font-semibold tracking-widest flex items-center gap-3">
                    <span x-text="cloud.active ? txt.sync_auto : txt.storage_local"></span>
                    <span class="text-[var(--glass-border)]">|</span>
                    <span x-text="currentTime" class="text-[var(--text-accent)] font-mono"></span>
                </div>
            </div>

            <div class="flex flex-wrap gap-3 items-center relative">
                <!-- THEME BUTTON -->
                <button @click="toggleTheme()" class="btn-tac px-4 py-2 text-xs">
                    <span x-text="theme === 'dark' ? '‚òÄ' : 'üåô'"></span>
                </button>

                <div class="h-6 w-px bg-[var(--glass-border)] mx-1"></div>

                <!-- DATA OPS DROPDOWN -->
                <div x-data="{ menuOpen: false }" @click.outside="menuOpen = false" class="relative">
                    <button @click="menuOpen = !menuOpen"
                            class="btn-tac px-4 py-2 text-xs flex items-center gap-2"
                            :class="cloud.active ? 'border-[var(--text-accent)] text-[var(--text-accent)] shadow-[0_0_10px_rgba(56,189,248,0.2)]' : ''">
                        <span x-text="cloud.active ? txt.cloud_sync : txt.data_ops"></span>
                        <span class="text-[10px]">‚ñº</span>
                    </button>

                    <!-- ‰∏ãÊãâËèúÂçïÂÜÖÂÆπ -->
                    <div x-show="menuOpen"
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:enter-start="opacity-0 scale-95"
                         x-transition:enter-end="opacity-100 scale-100"
                         class="hud-dropdown absolute right-0 top-full mt-2 w-56 flex flex-col shadow-2xl">

                        <!-- 0. LANGUAGE SWITCHER (Êñ∞Â¢û) -->
                        <div class="p-3 border-b border-[var(--glass-border)]">
                            <div class="text-[9px] font-bold text-[var(--text-sec)] tracking-widest mb-2" x-text="txt.mode_lang"></div>
                            <button @click="toggleLang(); menuOpen = false" class="w-full text-left text-xs font-bold text-[var(--text-pri)] hover:text-[var(--text-accent)] py-1 flex justify-between items-center group">
                                <span x-text="lang === 'en' ? 'SWITCH TO ‰∏≠Êñá' : 'SWITCH TO ENG'"></span>
                                <span class="text-[var(--text-accent)]">üåê</span>
                            </button>
                        </div>

                        <!-- 1. CLOUD MODE -->
                        <div class="p-3 border-b border-[var(--glass-border)] bg-[rgba(56,189,248,0.05)]">
                            <div class="text-[9px] font-bold text-[var(--text-accent)] tracking-widest mb-2" x-text="txt.mode_cloud"></div>
                            <template x-if="!cloud.active">
                                <button @click="cloudModal.open = true; menuOpen = false" class="w-full text-left text-xs font-bold text-[var(--text-pri)] hover:text-[var(--text-accent)] py-1 flex items-center gap-2 group">
                                    <span class="text-[var(--text-sec)] group-hover:text-[var(--text-accent)]">‚ö°</span> <span x-text="txt.connect_server"></span>
                                </button>
                            </template>
                            <template x-if="cloud.active">
                                <div>
                                    <div class="text-[10px] text-[var(--text-pri)] mb-2 truncate">ID: <span x-text="cloud.binId.substring(0,6)+'...'"></span></div>
                                    <button @click="disconnectCloud(); menuOpen = false" class="w-full text-center text-[10px] btn-tac py-1 border-[var(--alert-red)] text-[var(--alert-red)] hover:bg-[var(--alert-red)] hover:text-white" x-text="txt.disconnect"></button>
                                </div>
                            </template>
                        </div>

                        <!-- 2 & 3. FILE MODE -->
                        <div class="p-3">
                            <div class="text-[9px] font-bold text-[var(--text-sec)] tracking-widest mb-2" x-text="txt.mode_file"></div>

                            <!-- 2. Export -->
                            <button @click="exportData(); menuOpen = false" class="w-full text-left text-xs text-[var(--text-sec)] hover:text-[var(--text-pri)] py-1.5 flex justify-between items-center group">
                                <span x-text="txt.download_json"></span>
                                <span class="text-[var(--text-accent)] opacity-0 group-hover:opacity-100">‚Üì</span>
                            </button>

                            <!-- 3. Import -->
                            <button @click="$refs.fileInput.click(); menuOpen = false" class="w-full text-left text-xs text-[var(--text-sec)] hover:text-[var(--text-pri)] py-1.5 flex justify-between items-center group">
                                <span x-text="txt.upload_json"></span>
                                <span class="text-[var(--alert-red)] opacity-0 group-hover:opacity-100">‚Üë</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- NEW MISSION BUTTON -->
                <button @click="openMissionModal()" class="btn-red px-6 py-2 text-xs font-bold tracking-widest ml-2">
                    <span x-text="txt.new_mission"></span>
                </button>

                <input x-ref="fileInput" type="file" class="hidden" accept=".json" @change="importData($event)">
            </div>
        </header>

        <!-- DASHBOARD -->
        <section class="mb-12 grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="hud-card p-6 flex flex-col justify-between h-32">
                <div class="flex justify-between items-start">
                    <span class="deco-text" x-text="txt.global_status"></span>
                    <span class="text-[var(--text-accent)] text-xs">AVG</span>
                </div>
                <div class="flex items-baseline gap-2">
                    <span class="text-6xl font-bold text-[var(--text-pri)]" style="text-shadow: var(--alert-glow)" x-text="stats.overallProgress"></span>
                    <span class="text-xl text-[var(--text-sec)]">%</span>
                </div>
                <div class="bar-bg mt-2"><div class="bar-fill" :style="`width: ${stats.overallProgress}%`"></div></div>
            </div>

            <div class="hud-card p-6 h-32">
                <span class="deco-text" x-text="txt.active_ops"></span>
                <div class="flex gap-8 mt-4">
                    <div>
                        <div class="text-3xl font-bold text-[var(--alert-red)]" x-text="stats.projectCount"></div>
                        <div class="text-xs text-[var(--text-sec)] font-bold tracking-wider" x-text="txt.projects"></div>
                    </div>
                    <div>
                        <div class="text-3xl font-bold text-[var(--text-accent)]" x-text="stats.habitCount"></div>
                        <div class="text-xs text-[var(--text-sec)] font-bold tracking-wider" x-text="txt.routines"></div>
                    </div>
                </div>
            </div>

            <div class="md:col-span-2 hud-card p-6 h-32 overflow-hidden flex flex-col">
                 <span class="deco-text mb-3" x-text="txt.sector_analysis"></span>
                 <div class="overflow-y-auto pr-2 space-y-2 flex-1">
                    <template x-for="op in stats.opsBreakdown" :key="op.name">
                        <div class="flex justify-between items-center text-sm border-b border-[var(--glass-border)] pb-1 last:border-0">
                            <span class="text-[var(--text-pri)] font-semibold truncate w-1/2" x-text="op.name"></span>
                            <div class="flex items-center gap-3 w-1/2 justify-end">
                                <div class="bar-bg w-24 h-1"><div class="bar-fill" :style="`width: ${op.progress}%`"></div></div>
                                <span class="w-8 text-right font-bold" :class="op.progress >= 80 ? 'text-[var(--text-accent)]' : 'text-[var(--alert-red)]'" x-text="op.progress + '%'"></span>
                            </div>
                        </div>
                    </template>
                 </div>
            </div>
        </section>
        <!-- MAIN LIST -->
        <div class="space-y-12">
            <template x-for="obj in data.objectives" :key="obj.id">
                <!-- ‰øÆÊîπÁÇπ1ÔºöÂ¢ûÂä† x-data="{ expanded: true }" -->
                <div class="relative pl-6 border-l border-[var(--glass-border)]" x-data="{ expanded:false }">
                    <div class="absolute -left-[5px] top-0 w-2 h-2 bg-[var(--text-accent)]"></div>

                    <!-- ‰øÆÊîπÁÇπ2ÔºöÊ†áÈ¢òÊ†èÂ¢ûÂä†‰∫ÜÊäòÂè†ÊåâÈíÆ -->
                    <div class="flex items-center gap-4 mb-6 group">
                        <button @click="expanded = !expanded" class="text-[var(--text-sec)] hover:text-[var(--text-accent)] transition-transform duration-200" :class="expanded ? 'rotate-0' : '-rotate-90'">
                            ‚ñº
                        </button>

                        <div class="text-xs font-bold bg-[var(--glass-border)] text-[var(--text-pri)] px-2 py-0.5 tracking-widest">OP</div>
                        <div x-data="{ editing: false, tempTitle: obj.title }" class="flex-1">
                            <h2 x-show="!editing" @click="editing = true; $nextTick(()=>$refs.titleInput.focus())"
                                class="text-2xl font-bold uppercase tracking-wider cursor-pointer hover:text-[var(--text-accent)] transition">
                                <span class="text-[var(--alert-red)] mr-2">///</span><span x-text="obj.title"></span>
                            </h2>
                            <input x-ref="titleInput" x-show="editing" x-model="tempTitle"
                                   @blur="obj.title = tempTitle; editing = false; save()"
                                   @keydown.enter="obj.title = tempTitle; editing = false; save()"
                                   class="text-2xl font-bold uppercase w-full max-w-md bg-transparent border-b border-[var(--text-accent)]">
                        </div>
                        <button @click="deleteObjective(obj.id)" class="btn-tac px-2 py-1 text-[10px] opacity-0 group-hover:opacity-100 text-[var(--alert-red)] border-[var(--alert-red)] hover:bg-[var(--alert-red)] hover:text-white" x-text="txt.terminate_op"></button>
                    </div>

                    <!-- ‰øÆÊîπÁÇπ3Ôºögrid Â¢ûÂä†‰∫Ü x-show ÂíåÂä®Áîª -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" 
                         x-show="expanded" 
                         x-transition:enter="transition ease-out duration-200"
                         x-transition:enter-start="opacity-0 -translate-y-2"
                         x-transition:enter-end="opacity-100 translate-y-0">
                        
                        <template x-for="kr in obj.key_results" :key="kr.id">
                            <div class="hud-card p-6 flex flex-col h-full group hover:border-[var(--glass-border)] transition-colors">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="flex-1 pr-4">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="text-[10px] font-bold tracking-widest text-[var(--text-accent)]" x-text="kr.type === 'habit' ? txt.routine_label : txt.project_label"></span>
                                            <span class="text-[var(--glass-border)]">|</span>
                                            <template x-if="kr.type === 'habit'">
                                                <span class="text-[10px] text-[var(--text-sec)] font-bold">
                                                    <span x-text="txt.target"></span>: <span class="text-[var(--text-pri)]" x-text="kr.target_value || 7"></span><span x-text="txt.per_wk"></span>
                                                </span>
                                            </template>
                                        </div>
                                        <h3 class="text-xl font-bold text-[var(--text-pri)] leading-tight" x-text="kr.title"></h3>
                                        <p class="text-xs text-[var(--text-sec)] mt-1 uppercase" x-text="kr.desc"></p>
                                    </div>
                                    <div class="flex flex-col gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button @click="editMission(obj.id, kr.id)" class="text-[var(--text-sec)] hover:text-[var(--text-accent)] text-xs font-bold">[EDIT]</button>
                                        <button @click="deleteMission(obj.id, kr.id)" class="text-[var(--text-sec)] hover:text-[var(--alert-red)] text-xs font-bold">[DEL]</button>
                                    </div>
                                </div>

                                <template x-if="kr.type === 'habit'">
                                    <div class="mt-auto pt-4" x-data="{ weekOffset: 0 }">
                                        <div class="flex justify-between items-end mb-3 border-b border-[var(--glass-border)] pb-1">
                                            <button @click="weekOffset++" class="text-xs font-bold text-[var(--text-sec)] hover:text-[var(--text-pri)]" x-text="txt.prev"></button>
                                            <div class="text-center">
                                                <div class="text-[10px] text-[var(--text-accent)] font-bold tracking-widest" x-text="getWeekRangeLabel(weekOffset)"></div>
                                                <div x-show="weekOffset === 0" class="text-[10px] font-bold text-[var(--text-pri)]">
                                                    <span x-text="txt.status"></span>: <span x-text="calculateHabitScore(kr, 0) + '%'"></span>
                                                </div>
                                            </div>
                                            <button @click="weekOffset--" class="text-xs font-bold text-[var(--text-sec)] hover:text-[var(--text-pri)]" :disabled="weekOffset===0" :class="weekOffset===0 ? 'opacity-30' : ''" x-text="txt.next"></button>
                                        </div>
                                        <div class="grid grid-cols-7 gap-1 h-12">
                                            <template x-for="(d, idx) in getWeekDays(weekOffset)" :key="d.date">
                                                <button @click="toggleDate(kr, d.date)"
                                                        class="relative flex flex-col items-center justify-center border transition-all duration-200 group/btn"
                                                        :class="kr.records && kr.records[d.date] ? 'bg-[rgba(239,68,68,0.2)] border-[var(--alert-red)]' : 'bg-[rgba(0,0,0,0.2)] border-[var(--glass-border)] hover:border-[var(--text-accent)]'">
                                                    <span class="text-[10px] font-bold" :class="kr.records && kr.records[d.date] ? 'text-[var(--alert-red)]' : 'text-[var(--text-sec)]'" x-text="['M','T','W','T','F','S','S'][idx]"></span>
                                                    <div class="w-1.5 h-1.5 mt-1 rounded-full transition-colors" :class="kr.records && kr.records[d.date] ? 'bg-[var(--alert-red)] shadow-[0_0_5px_var(--alert-red)]' : 'bg-[var(--glass-border)]'"></div>
                                                    <div x-show="d.date === today" class="absolute top-0 w-full h-0.5 bg-[var(--text-accent)]"></div>
                                                </button>
                                            </template>
                                        </div>
                                        <button @click="openHeatmap(kr)" class="w-full text-center text-[9px] font-bold tracking-widest text-[var(--text-sec)] hover:text-[var(--text-accent)] mt-3" x-text="txt.access_history"></button>
                                    </div>
                                </template>

                                <template x-if="kr.type === 'project'">
                                    <div class="mt-4">
                                        <div class="flex items-center gap-3 mb-2">
                                            <div class="bar-bg"><div class="bar-fill" :style="`width: ${kr.current_progress}%`"></div></div>
                                            <div class="font-bold text-[var(--alert-red)] w-10 text-right" x-text="kr.current_progress + '%'"></div>
                                        </div>
                                        <div class="flex gap-0 mb-4" x-data="{ log: '', prog: kr.current_progress }">
                                            <input type="text" x-model="log" :placeholder="txt.enter_intel" class="flex-1 text-xs px-3 py-2 text-[var(--text-pri)] placeholder-[var(--text-sec)] bg-[rgba(0,0,0,0.3)] border-r-0">
                                            <input type="number" x-model="prog" min="0" max="100" class="w-14 text-xs text-center border-l border-[var(--glass-border)] bg-[rgba(0,0,0,0.3)]">
                                            <button @click="if(log){ addLog(kr, log, prog); log=''; }" class="btn-tac px-3 text-xs bg-[var(--glass-border)] hover:bg-[var(--text-accent)] hover:text-black">ADD</button>
                                        </div>
                                        <div class="h-28 overflow-y-auto pr-1 space-y-1 custom-scroll">
                                            <template x-for="(log, idx) in (kr.logs || []).slice().reverse()" :key="idx">
                                                <div class="flex text-[10px] gap-2 items-start p-1 border-b border-[var(--glass-border)] group/log">
                                                    <span class="text-[var(--text-accent)] font-bold shrink-0" x-text="log.date.slice(5)"></span>
                                                    <span class="text-[var(--text-pri)] flex-1" x-text="log.content"></span>
                                                    <span class="text-[var(--text-sec)]" x-text="log.progress_snapshot + '%'"></span>
                                                    <button @click="deleteLog(kr, (kr.logs.length - 1 - idx))" class="text-[var(--alert-red)] font-bold opacity-0 group-hover/log:opacity-100 hover:scale-125 transition">√ó</button>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                        
                        <!-- ‰øÆÊîπÁÇπ4ÔºöËøôÈáåÂéüÊúâÁöÑËôöÁ∫ø‚ÄúÊñ∞Âª∫‰ªªÂä°‚ÄùÂç°ÁâáÂ∑≤ÁªèË¢´ÁßªÈô§‰∫Ü -->

                    </div>
                </div>
            </template>
        </div>
      

        <!-- CLOUD CONFIG MODAL -->
        <div x-show="cloudModal.open" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-md" x-cloak>
            <div class="hud-card p-8 w-full max-w-md shadow-2xl relative">
                <div class="absolute top-0 left-0 w-full h-1 bg-[var(--text-accent)]"></div>
                <button @click="cloudModal.open = false" class="absolute top-4 right-4 text-[var(--text-sec)] hover:text-[var(--alert-red)] font-bold text-xl">√ó</button>
                <h3 class="text-2xl font-bold text-[var(--text-pri)] mb-2">UPLINK <span class="text-[var(--text-accent)]">CONFIGURATION</span></h3>
                <p class="text-xs text-[var(--text-sec)] mb-6" x-text="txt.cloud_desc"></p>

                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-[var(--text-accent)] uppercase mb-1">API MASTER KEY</label>
                        <input type="text" x-model="cloudModal.apiKey" placeholder="sk-..." class="w-full p-2 text-xs">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-[var(--text-accent)] uppercase mb-1">BIN ID</label>
                        <input type="text" x-model="cloudModal.binId" placeholder="65a..." class="w-full p-2 text-xs">
                    </div>
                    <div class="flex gap-3 mt-4">
                        <button @click="disconnectCloud()" class="flex-1 btn-tac py-3 text-xs text-[var(--alert-red)] border-[var(--alert-red)] hover:bg-[var(--alert-red)] hover:text-white">DISCONNECT</button>
                        <button @click="connectCloud()" class="flex-1 btn-tac py-3 text-xs border-[var(--text-accent)] text-[var(--text-accent)] hover:bg-[var(--text-accent)] hover:text-black">CONNECT & SYNC</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- HEATMAP MODAL -->
        <div x-show="heatmapModal.open" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-md" x-cloak>
            <div class="hud-card p-8 w-full max-w-2xl shadow-2xl relative">
                <div class="absolute top-0 left-0 w-full h-1 bg-[var(--text-accent)]"></div>
                <button @click="heatmapModal.open = false" class="absolute top-4 right-4 text-[var(--text-sec)] hover:text-[var(--alert-red)] font-bold text-xl">√ó</button>
                <h3 class="text-2xl font-bold text-[var(--text-pri)] mb-1">DATA <span class="text-[var(--text-accent)]">VISUALIZATION</span></h3>
                <p class="deco-text mb-6 flex items-center gap-4">
                    <span>HISTORICAL PATTERN // <span x-text="heatmapModal.title"></span></span>
                    <span class="h-3 w-px bg-[var(--text-sec)] opacity-50"></span>
                    <span><span x-text="txt.total_exec"></span>: <span class="text-[var(--text-accent)] font-bold text-lg ml-1" x-text="heatmapModal.totalDays"></span> DAYS</span>
                </p>
                <div class="flex gap-1 overflow-x-auto pb-4 custom-scroll">
                    <template x-for="week in heatmapData" :key="week.weekIndex">
                        <div class="flex flex-col gap-1">
                            <template x-for="day in week.days" :key="day.date">
                                <div class="w-3 h-3 border border-transparent" :title="day.date"
                                     :class="day.done ? 'bg-[var(--alert-red)] shadow-[0_0_4px_var(--alert-red)]' : 'bg-[var(--tech-line)]'">
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- MISSION MODAL -->
        <div x-show="missionModal.open" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-md" x-cloak>
            <div class="hud-card p-8 w-full max-w-md shadow-2xl relative">
                <div class="absolute top-0 left-0 w-full h-1 bg-[var(--alert-red)]"></div>
                <h2 class="text-2xl font-bold mb-6 text-[var(--text-pri)] tracking-wide">
                    <span x-text="missionModal.isEdit ? txt.action_edit : txt.action_init"></span> <span class="text-[var(--alert-red)]">MISSION</span>
                </h2>
                <div class="space-y-5">
                    <div>
                        <label class="block text-xs font-bold text-[var(--text-accent)] uppercase mb-1" x-text="txt.form_title"></label>
                        <input type="text" x-model="missionModal.form.title" class="w-full p-2">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-[var(--text-accent)] uppercase mb-1" x-text="txt.form_tag"></label>
                        <input type="text" x-model="missionModal.form.tag" list="ops-list" placeholder="TYPE NEW OR SELECT..." class="w-full p-2 uppercase">
                        <datalist id="ops-list"><template x-for="op in data.objectives"><option :value="op.title"></option></template></datalist>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div @click="missionModal.form.type = 'habit'" class="cursor-pointer border p-4 text-center transition hover:border-[var(--text-accent)]" :class="missionModal.form.type === 'habit' ? 'border-[var(--text-accent)] bg-[rgba(56,189,248,0.1)]' : 'border-[var(--glass-border)]'"><div class="font-bold text-sm text-[var(--text-pri)]" x-text="txt.routine_label"></div></div>
                        <div @click="missionModal.form.type = 'project'" class="cursor-pointer border p-4 text-center transition hover:border-[var(--alert-red)]" :class="missionModal.form.type === 'project' ? 'border-[var(--alert-red)] bg-[rgba(239,68,68,0.1)]' : 'border-[var(--glass-border)]'"><div class="font-bold text-sm text-[var(--text-pri)]" x-text="txt.project_label"></div></div>
                    </div>
                    <div x-show="missionModal.form.type === 'habit'" class="p-4 border border-[var(--glass-border)] bg-[rgba(0,0,0,0.1)]">
                        <label class="block text-xs font-bold text-[var(--text-sec)] uppercase mb-2" x-text="txt.form_freq"></label>
                        <div class="flex items-center gap-4">
                            <input type="range" x-model="missionModal.form.target_value" min="1" max="7" class="flex-1 accent-[var(--text-accent)]">
                            <span class="text-2xl font-bold text-[var(--text-accent)] w-8 text-center" x-text="missionModal.form.target_value"></span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-[var(--text-accent)] uppercase mb-1" x-text="txt.form_notes"></label>
                        <textarea x-model="missionModal.form.desc" rows="2" class="w-full p-2"></textarea>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button @click="missionModal.open = false" class="flex-1 btn-tac py-3 text-xs" x-text="txt.cancel"></button>
                        <button @click="saveMission()" class="flex-1 btn-red py-3 text-xs font-bold" x-text="txt.confirm"></button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        function spyTracker() {
            return {
                theme: 'dark',
                lang: 'en', // ÈªòËÆ§ËØ≠Ë®Ä
                today: new Date().toISOString().split('T')[0],
                currentTime: '',
                data: { objectives: [] },

                // CLOUD
                cloud: { active: false, apiKey: '', binId: '' },
                cloudModal: { open: false, apiKey: '', binId: '' },

                heatmapModal: { open: false, title: '', totalDays: 0 },
                heatmapData: [],
                missionModal: { open: false, isEdit: false, editingObjId: null, editingKrId: null, form: { title: '', tag: '', type: 'habit', desc: '', target_value: 7 } },

                // --- Â≠óÂÖ∏Êï∞ÊçÆ ---
                dictionary: {
                    en: {
                        online: 'IMF_SECURE_LINK // ONLINE', offline: 'IMF_LOCAL_CACHE // OFFLINE',
                        sync_auto: 'SYNC: AUTO', storage_local: 'STORAGE: LOCAL',
                        cloud_sync: '‚òÅ CLOUD SYNC', data_ops: 'üíæ DATA OPS',
                        mode_lang: 'MODE 00 // LANGUAGE', mode_cloud: 'MODE 01 // CLOUD LINK', mode_file: 'MODE 02 // MANUAL FILE',
                        connect_server: 'CONNECT SERVER', disconnect: 'DISCONNECT',
                        download_json: 'DOWNLOAD JSON', upload_json: 'UPLOAD JSON',
                        new_mission: '+ NEW MISSION',
                        global_status: '/// GLOBAL_STATUS', active_ops: '/// ACTIVE_OPERATIONS', sector_analysis: '/// SECTOR_ANALYSIS',
                        projects: 'PROJECTS', routines: 'ROUTINES',
                        terminate_op: 'TERMINATE OP',
                        routine_label: 'ROUTINE', project_label: 'PROJECT',
                        target: 'TARGET', per_wk: '/WK',
                        prev: '< PREV', next: 'NEXT >', status: 'STATUS',
                        access_history: '> ACCESS_LONG_TERM_DATA',
                        enter_intel: 'ENTER INTEL...',
                        cloud_desc: 'CONNECT TO JSONBIN.IO FOR SYNC. (Separate BIN IDs for different agents)',
                        total_exec: 'TOTAL EXECUTIONS',
                        action_edit: 'EDIT', action_init: 'INITIATE',
                        form_title: 'OBJECTIVE TITLE', form_tag: 'OPERATION TAG', form_freq: 'WEEKLY FREQUENCY TARGET', form_notes: 'BRIEFING NOTES',
                        cancel: 'CANCEL', confirm: 'CONFIRM'
                    },
                    cn: {
                        online: 'Âä†ÂØÜÈìæË∑Ø // Â∑≤ËøûÊé•', offline: 'Êú¨Âú∞ÁºìÂ≠ò // Á¶ªÁ∫øÊ®°Âºè',
                        sync_auto: 'ÂêåÊ≠•ÔºöËá™Âä®', storage_local: 'Â≠òÂÇ®ÔºöÊú¨Âú∞',
                        cloud_sync: '‚òÅ ‰∫ëÁ´ØÈìæË∑Ø', data_ops: 'üíæ Êï∞ÊçÆÊìç‰Ωú',
                        mode_lang: 'Ê®°Âºè 00 // ËØ≠Ë®ÄËÆæÁΩÆ', mode_cloud: 'Ê®°Âºè 01 // ‰∫ëÁ´ØËøûÊé•', mode_file: 'Ê®°Âºè 02 // ÊâãÂä®ÂΩíÊ°£',
                        connect_server: 'ËøûÊé•ÊúçÂä°Âô®', disconnect: 'Êñ≠ÂºÄËøûÊé•',
                        download_json: 'ÂØºÂá∫Êï∞ÊçÆ (JSON)', upload_json: 'ÂØºÂÖ•Êï∞ÊçÆ (JSON)',
                        new_mission: '+ Âª∫Á´ãÊñ∞Ë°åÂä®',
                        global_status: '/// ÂÖ®Â±ÄÁä∂ÊÄÅ', active_ops: '/// Ê¥ªË∑ÉË°åÂä®', sector_analysis: '/// Âå∫ÂùóÂàÜÊûê',
                        projects: '‰∏ìÈ°πË°åÂä®', routines: 'Â∏∏ËßÑÂçèËÆÆ',
                        terminate_op: 'ÁªàÊ≠¢Ë°åÂä®',
                        routine_label: 'Â∏∏ËßÑ', project_label: '‰∏ìÈ°π',
                        target: 'ÊåáÊ†á', per_wk: '/Âë®',
                        prev: '< ‰∏äÂë®', next: '‰∏ãÂë® >', status: 'Áä∂ÊÄÅ',
                        access_history: '> ËÆøÈóÆÂéÜÂè≤Êï∞ÊçÆ (LONG_TERM)',
                        enter_intel: 'ÂΩïÂÖ•Êñ∞ÊÉÖÊä•...',
                        cloud_desc: 'ËøûÊé• JSONBIN.IO ËøõË°åÂêåÊ≠•„ÄÇ(Â§ö‰∫∫ËØ∑‰ΩøÁî®‰∏çÂêåÁöÑ BIN ID)',
                        total_exec: 'ÊâßË°åÊÄªËÆ°',
                        action_edit: 'ÁºñËæë', action_init: 'ÂêØÂä®',
                        form_title: 'Ë°åÂä®‰ª£Âè∑ (TITLE)', form_tag: 'ÊâÄÂ±ûË°åÂä®ÁªÑ (TAG)', form_freq: 'Âë®È¢ëÊ¨°ÁõÆÊ†á', form_notes: 'ÊÉÖÊä•ÊëòË¶Å (NOTES)',
                        cancel: 'ÂèñÊ∂à', confirm: 'Á°ÆËÆ§ÊâßË°å'
                    }
                },

                get txt() {
                    return this.dictionary[this.lang];
                },

                toggleLang() {
                    this.lang = this.lang === 'en' ? 'cn' : 'en';
                    localStorage.setItem('okr_lang', this.lang);
                },

                init() {
                    const savedTheme = localStorage.getItem('okr_theme');
                    if (savedTheme) this.theme = savedTheme;

                    // Âä†ËΩΩËØ≠Ë®ÄËÆæÁΩÆ
                    const savedLang = localStorage.getItem('okr_lang');
                    if (savedLang) this.lang = savedLang;

                    const cloudConfig = JSON.parse(localStorage.getItem('okr_cloud_config'));
                    if (cloudConfig && cloudConfig.apiKey && cloudConfig.binId) {
                        this.cloud.active = true;
                        this.cloud.apiKey = cloudConfig.apiKey;
                        this.cloud.binId = cloudConfig.binId;
                        this.cloudModal.apiKey = cloudConfig.apiKey;
                        this.cloudModal.binId = cloudConfig.binId;
                        this.loadFromCloud();
                    } else {
                        const saved = localStorage.getItem('okr_v3_spy');
                        if (saved) {
                            this.data = JSON.parse(saved);
                            this.fixDataStructure();
                        } else {
                            this.initDemoData();
                        }
                    }
                    this.updateTime();
                    setInterval(() => this.updateTime(), 1000);
                },

                async loadFromCloud() {
                    try {
                        const res = await fetch(`https://api.jsonbin.io/v3/b/${this.cloud.binId}/latest`, {
                            headers: { 'X-Master-Key': this.cloud.apiKey }
                        });
                        if (!res.ok) throw new Error('Cloud Link Failed');
                        const json = await res.json();
                        this.data = json.record;
                        this.fixDataStructure();
                        localStorage.setItem('okr_v3_spy', JSON.stringify(this.data));
                    } catch (e) {
                        alert('CLOUD SYNC FAILED: ' + e.message + '. USING LOCAL CACHE.');
                        const saved = localStorage.getItem('okr_v3_spy');
                        if (saved) this.data = JSON.parse(saved);
                    }
                },

                async saveToCloud() {
                    if (!this.cloud.active) return;
                    try {
                        await fetch(`https://api.jsonbin.io/v3/b/${this.cloud.binId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Master-Key': this.cloud.apiKey
                            },
                            body: JSON.stringify(this.data)
                        });
                    } catch (e) {
                        console.error('Background Sync Failed', e);
                    }
                },

                connectCloud() {
                    if(!this.cloudModal.apiKey || !this.cloudModal.binId) return alert('MISSING CREDENTIALS');
                    this.cloud.apiKey = this.cloudModal.apiKey;
                    this.cloud.binId = this.cloudModal.binId;
                    this.cloud.active = true;
                    localStorage.setItem('okr_cloud_config', JSON.stringify({ apiKey: this.cloud.apiKey, binId: this.cloud.binId }));
                    this.cloudModal.open = false;
                    if(confirm('INITIALIZE: UPLOAD current local data to Cloud? (Cancel to download from Cloud)')) {
                        this.saveToCloud().then(() => alert('CLOUD INITIALIZED'));
                    } else {
                        this.loadFromCloud().then(() => alert('DATA DOWNLOADED'));
                    }
                },

                disconnectCloud() {
                    this.cloud.active = false;
                    this.cloud.apiKey = '';
                    this.cloud.binId = '';
                    localStorage.removeItem('okr_cloud_config');
                    this.cloudModal.open = false;
                    alert('DISCONNECTED. SWITCHING TO LOCAL STORAGE.');
                },

                updateTime() {
                    this.currentTime = new Date().toLocaleTimeString('en-US', { hour12: false });
                },

                toggleTheme() { this.theme = this.theme === 'dark' ? 'light' : 'dark'; localStorage.setItem('okr_theme', this.theme); },

                save() {
                    localStorage.setItem('okr_v3_spy', JSON.stringify(this.data));
                    if (this.cloud.active) {
                        this.saveToCloud();
                    }
                },

                initDemoData() {
                    this.data = { objectives: [{ id: 1, title: "HEALTH_OPS", key_results: [{ id: 101, title: "Morning Run", desc: "Stamina +5", type: "habit", target_value: 3, records: {} }] }] };
                    this.save();
                },
                fixDataStructure() {
                    this.data.objectives.forEach(obj => { obj.key_results.forEach(kr => { if (kr.type === 'habit' && !kr.target_value) kr.target_value = 7; }); });
                },

                get stats() {
                    let totalItems = 0, progressSum = 0, projectCount = 0, habitCount = 0, opsBreakdown = [];
                    if(!this.data.objectives) return { overallProgress: 0, projectCount: 0, habitCount: 0, opsBreakdown: [] };
                    this.data.objectives.forEach(obj => {
                        let opProgressSum = 0, opItemCount = 0;
                        obj.key_results.forEach(kr => {
                            totalItems++; opItemCount++; let score = 0;
                            if(kr.type === 'project') { projectCount++; score = parseInt(kr.current_progress || 0); }
                            else { habitCount++; score = this.calculateHabitScore(kr, 0); }
                            progressSum += score; opProgressSum += score;
                        });
                        const opAvg = opItemCount > 0 ? Math.round(opProgressSum / opItemCount) : 0;
                        opsBreakdown.push({ name: obj.title, progress: opAvg });
                    });
                    const overallAvg = totalItems > 0 ? Math.round(progressSum / totalItems) : 0;
                    return { overallProgress: overallAvg, projectCount, habitCount, opsBreakdown };
                },
                calculateHabitScore(kr, weekOffset) {
                    const days = this.getWeekDays(weekOffset);
                    const doneCount = days.filter(d => kr.records && kr.records[d.date]).length;
                    const target = kr.target_value || 7;
                    return Math.min(100, Math.round((doneCount / target) * 100));
                },
                getWeekDays(offset) {
                    const d = new Date(); const day = d.getDay();
                    const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                    const monday = new Date(d.setDate(diff)); monday.setDate(monday.getDate() - (offset * 7));
                    let week = []; for (let i = 0; i < 7; i++) { const temp = new Date(monday); temp.setDate(monday.getDate() + i); week.push({ date: temp.toISOString().split('T')[0] }); }
                    return week;
                },
                getWeekRangeLabel(offset) {
                    const days = this.getWeekDays(offset);
                    const start = days[0].date.slice(5).replace('-','/'); const end = days[6].date.slice(5).replace('-','/');
                    return offset === 0 ? `CURRENT WEEK (${start}-${end})` : `WEEK -${offset} (${start}-${end})`;
                },
                toggleDate(kr, dateStr) { if (!kr.records) kr.records = {}; if (kr.records[dateStr]) delete kr.records[dateStr]; else kr.records[dateStr] = true; this.save(); },
                openHeatmap(kr) {
                    this.heatmapModal.title = kr.title;
                    this.heatmapModal.totalDays = kr.records ? Object.keys(kr.records).length : 0;
                    this.heatmapModal.open = true;
                    this.generateHeatmapData(kr);
                },
                generateHeatmapData(kr) {
                    const end = new Date(); const dayOfWeek = end.getDay();
                    const gridEnd = new Date(end); gridEnd.setDate(end.getDate() + (dayOfWeek === 0 ? 0 : 7 - dayOfWeek));
                    let result = []; for(let i = 24; i >= 0; i--) {
                        let weekDays = []; let weekEnd = new Date(gridEnd); weekEnd.setDate(gridEnd.getDate() - (i * 7));
                        for(let d = 6; d >= 0; d--) {
                            let dt = new Date(weekEnd); dt.setDate(weekEnd.getDate() - d); const dateStr = dt.toISOString().split('T')[0];
                            weekDays.push({ date: dateStr, done: !!(kr.records && kr.records[dateStr]) });
                        }
                        result.push({ weekIndex: i, days: weekDays });
                    }
                    this.heatmapData = result;
                },
                openMissionModal(prefillObjId=null) {
                    this.missionModal.open=true; this.missionModal.isEdit=false; this.missionModal.form={title:'',tag:'',type:'habit',desc:'', target_value: 7};
                    if(prefillObjId){const o=this.data.objectives.find(x=>x.id===prefillObjId);if(o)this.missionModal.form.tag=o.title;}
                },
                editMission(objId, krId) {
                    const o = this.data.objectives.find(x => x.id === objId); if (!o) return;
                    const k = o.key_results.find(x => x.id === krId); if (!k) return;
                    this.missionModal.open=true; this.missionModal.isEdit=true; this.missionModal.editingObjId=objId; this.missionModal.editingKrId=krId;
                    this.missionModal.form={title:k.title,tag:o.title,type:k.type,desc:k.desc||'', target_value: k.target_value || 7};
                },
                saveMission() {
                    const f=this.missionModal.form; if(!f.title||!f.tag)return alert('MISSING INTEL');
                    let target=this.data.objectives.find(o=>o.title.toUpperCase()===f.tag.toUpperCase());
                    if(!target){target={id:Date.now(),title:f.tag.toUpperCase(),key_results:[]};this.data.objectives.push(target);}
                    const newKRData = { title: f.title, desc: f.desc, type: f.type, target_value: parseInt(f.target_value) };
                    if(this.missionModal.isEdit){
                        const oldObj=this.data.objectives.find(o=>o.id===this.missionModal.editingObjId);
                        if (oldObj) {
                            const krIndex = oldObj.key_results.findIndex(k => k.id === this.missionModal.editingKrId);
                            if (krIndex > -1) {
                                const kr = oldObj.key_results[krIndex]; Object.assign(kr, newKRData);
                                if(oldObj.id!==target.id){ oldObj.key_results.splice(krIndex,1); target.key_results.push(kr); if(!oldObj.key_results.length) this.data.objectives=this.data.objectives.filter(o=>o.id!==oldObj.id); }
                            }
                        }
                    }else{ target.key_results.push({ id:Date.now(), ...newKRData, current_progress:0,records:{},logs:[] }); }
                    this.save(); this.missionModal.open=false;
                },
                deleteMission(objId, krId){ if(!confirm('CONFIRM DELETION?')) return; const o = this.data.objectives.find(x => x.id === objId); if (!o) return; o.key_results = o.key_results.filter(k => k.id !== krId); if(!o.key_results.length) { this.data.objectives = this.data.objectives.filter(x => x.id !== objId); } this.save(); },
                deleteObjective(objId){ if(!confirm('TERMINATE ENTIRE OPERATION?')) return; this.data.objectives = this.data.objectives.filter(x => x.id !== objId); this.save(); },
                addLog(kr,c,p){if(!kr.logs)kr.logs=[];kr.logs.push({date:this.today,content:c,progress_snapshot:parseInt(p)});kr.current_progress=parseInt(p);this.save();},
                deleteLog(kr,idx){if(confirm('REMOVE INTEL?')){kr.logs.splice(idx,1);this.save();}},
                exportData(){const s="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(this.data,null,2));const a=document.createElement('a');a.href=s;a.download=`IMF_DATA_${this.today}.json`;a.click();},
                importData(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=(ev)=>{try{this.data=JSON.parse(ev.target.result);this.save();alert('DATABASE UPDATED');}catch(x){alert('CORRUPT DATA');}};r.readAsText(f);}
            }
        }
    </script>
</body>
</html>